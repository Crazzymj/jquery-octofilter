/*
 *  jQuery Octofilter - v0.0.1
 *  A jQuery plugin to categorized suggestions.
 *  https://github.com/zigotto/jquery-octofilter
 *
 *  Copyright (c) 2013 Marcelo Fraga
 *  MIT License
 */
(function(){var t,e,i=[].slice;t=jQuery,e=function(){function e(e,i){this.options=t.extend({},this.defaults,i),this.input=t(e),this.init()}return e.prototype.defaults={source:{},categories:{},paramName:"query",minChars:3},e.prototype.cacheData={},e.prototype.selectedFilters={},e.prototype.inputContainer=null,e.prototype.filtersContainer=null,e.prototype.init=function(){var e;return e=this,this.input.attr({autocomplete:"off"}),this.inputContainer=this.input.wrap('<div class="octofilter-input" />').parent(),this.search("",function(){return e.filtersContainer.on("click",".octofilter-link",function(i){return i.preventDefault(),i.stopPropagation(),e.select(t(this).data("value"))}),e.inputContainer.on("click",".octofilter-clear",function(i){return i.preventDefault(),i.stopPropagation(),e.clear(t(this).closest(".octofilter-label").data("value"))}),t(document).on("click",function(i){var n,o;return o=t(i.target),n=o.parents().add(o),-1===n.index(e.inputContainer)&&-1===n.index(e.filtersContainer)?e.filtersContainer.hide():void 0})}),this.inputContainer.on("click",function(){return e.input.focus()}),this.input.on("focus",function(){return e.filtersContainer.show()}).on("keydown",function(t){switch(t.keyCode||t.which){case 9:case 13:return t.preventDefault();case 8:if(!this.value.length)return e.clear(e.inputContainer.find(".octofilter-label:last").data("value"));break;case 27:return e.input.val("").blur(),e.filtersContainer.hide()}}).on("keyup",function(t){var i;switch(t.keyCode||t.which){case 9:case 13:if(i=e.filtersContainer.find(".octofilter-link.octofilter-active:first"),i.length)return e.select(i.data("value"));break;default:return this.value.length>=e.options.minChars?e.search(this.value):e.search("")}})},e.prototype.makeFilterContainer=function(){var e,i,n;return this.filtersContainer||(this.filtersContainer=t('<div class="octofilter-container"><ul class="nav nav-tabs"></ul><div class="tab-content"></div></div>').insertAfter(this.input)),n=function(){var n,o;n=this.options.categories,o=[];for(e in n)i=n[e],o.push(t("<li/>").html(t("<a/>",{href:"#octofilter-"+e,text:i,"class":"nav-"+e,"data-toggle":"tab"})));return o}.call(this),this.filtersContainer.find(".nav").html(n).find("li:first").addClass("active")},e.prototype.populateFilterContainer=function(e){var i,n,o,a,r,s,l,c,u;return c=this,e=t.extend({},e),t.isEmptyObject(this.options.categories)&&(t.each(e,function(t){return c.options.categories[t]=t}),this.makeFilterContainer()),o=function(){var o,r;o=this.options.categories,r=[];for(i in o)n=o[i],"string"==typeof e[i]&&(e[i]=t.parseJSON(e[i])),c.input.val().length>=c.options.minChars&&(e[i]=t.grep(e[i],function(t){return-1!==t.name.toLowerCase().indexOf(c.input.val().toLowerCase())})),a=function(){var n,o,a,r;if(e[i].length){for(a=e[i],r=[],n=0,o=a.length;o>n;n++)s=a[n],l="octofilter-link",-1!==t.inArray(s.value||s.name,this.selectedFilters[i])&&(l+=" octofiltered"),r.push(t("<a/>",{text:s.name,"class":l,"data-category":i,"data-value":s.value||s.name}));return r}return t("<span/>",{text:""+this.options.categories[i].toLowerCase()+" not found.","class":"octofilter-not-found"})}.call(this),r.push(t("<div/>",{id:"octofilter-"+i,"class":"tab-pane"}).html(a));return r}.call(this),this.filtersContainer.find(".tab-content").html(o),r=this.filtersContainer.find(".octofilter-link:not(.octofiltered):first"),u=r.length?r.closest(".tab-pane").addClass("active"):this.filtersContainer.find(".tab-pane:first").addClass("active"),this.filtersContainer.find("[href='#"+u.attr("id")+"']").tab("show"),this.input.val().length>=this.options.minChars?r.addClass("octofilter-active"):void 0},e.prototype.search=function(e,i){var n,o;if(o=this,this.cacheData[e]){if(this.populateFilterContainer(this.cacheData[e]),"function"==typeof i&&i.call(),"function"==typeof this.options.onSearch)return this.options.onSearch.apply(this,[this.cacheData[e]])}else{if("string"==typeof this.options.source)return n={},n[this.options.paramName]=e,t.getJSON(this.options.source,n,function(t){return o.cacheData[e]=t,null==o.filtersContainer&&o.makeFilterContainer(),o.populateFilterContainer(t),"function"==typeof i&&i.call(),"function"==typeof o.options.onSearch?o.options.onSearch.apply(o,[t]):void 0});if(null==this.filtersContainer&&this.makeFilterContainer(),this.populateFilterContainer(this.options.source),"function"==typeof i&&i.call(),"function"==typeof this.options.onSearch)return this.options.onSearch.apply(o,[this.options.source])}},e.prototype.select=function(e){var i,n,o,a,r;return n=this.filtersContainer.find(".octofilter-link[data-value='"+e+"']"),i=n.data("category"),-1!==t.inArray(e,this.selectedFilters[i])?(this.input.focus(),void 0):(null==(r=this.selectedFilters)[i]&&(r[i]=[]),this.selectedFilters[i].push(e),o=t("<span/>",{"class":"octofilter-label",text:n.text(),"data-value":e,"data-category":i}),t("<a/>",{"class":"octofilter-clear",html:"&times;"}).appendTo(o),a=this.inputContainer.find(".octofilter-label"),a.length?a.last().after(o):this.inputContainer.prepend(o),this.input.val("").focus(),this.search(""),"function"==typeof this.options.onSelect?this.options.onSelect.apply(this,[this.selectedFilters]):void 0)},e.prototype.clear=function(t){var e,i;return t?(i=this.inputContainer.find(".octofilter-label[data-value='"+t+"']").remove(),e=i.data("category"),this.selectedFilters[e].splice(this.selectedFilters[e].indexOf(t),1)):(this.inputContainer.find(".octofilter-label").remove(),this.selectedFilters={},this.input.val("")),this.input.focus(),this.search(this.input.val()),"function"==typeof this.options.onClear?this.options.onClear.apply(this,[this.selectedFilters]):void 0},e}(),t.fn.extend({octofilter:function(){var n,o;return o=arguments[0],n=arguments.length>=2?i.call(arguments,1):[],this.each(function(){var i,a;return i=t(this),a=i.data("octofilter"),a||i.data("octofilter",a=new e(this,o)),"string"==typeof o?a[o].apply(a,n):void 0})}})}).call(this);