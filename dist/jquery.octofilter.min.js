/*
 *  jQuery Octofilter - v0.0.1
 *  A jQuery plugin to categorized suggestions.
 *  https://github.com/zigotto/jquery-octofilter
 *
 *  Copyright (c) 2013 Marcelo Fraga
 *  MIT License
 */
(function(t){"use strict";var e=function(e,i){this.$input=t(e),this.options=i,this.init()};e.defaults={source:{},categories:{},paramName:"query",minChars:3},e.prototype.cacheData={},e.prototype.selectedFilters={},e.prototype.init=function(){var e=this;e.$input.attr({autocomplete:"off"}),e.$container=e.$input.wrap('<div class="octofilter-input"/>').parent(),e.$container.on("click",function(){e.$input.focus()}),e.$input.on("focus",function(){e.$filtersContainer.show()}).on("keydown",function(t){switch(t.keyCode||t.which){case 9:case 13:t.preventDefault();break;case 8:this.value.length||e.clear(e.$container.find(".octofilter-label:last").data("value"));break;case 27:e.$input.val("").blur(),e.$filtersContainer.hide()}}).on("keyup",function(t){switch(t.keyCode||t.which){case 9:case 13:var i=e.$filtersContainer.find(".octofilter-link.octofilter-active:first");i.length&&e.select(i.data("value"));break;default:this.value.length>=e.options.minChars?e.search(this.value):e.search("")}}),e.search("",function(){e.$filtersContainer.on("click",".octofilter-link",function(i){i.preventDefault(),i.stopPropagation(),e.select(t(this).data("value"))}),e.$container.on("click",".octofilter-clear",function(i){i.preventDefault(),i.stopPropagation(),e.clear(t(this).closest(".octofilter-label").data("value"))}),t(document).on("click",function(i){var o=t(i.target),a=o.parents().add(o);-1===a.index(e.$container)&&-1===a.index(e.$filtersContainer)&&e.$filtersContainer.hide()})})},e.prototype.makeFilterContainer=function(){var e=this;e.$filtersContainer||(e.$filtersContainer=t('<div class="octofilter-container"><ul class="nav nav-tabs"></ul><div class="tab-content"></div></div>').insertAfter(e.$input));var i=[];for(var o in e.options.categories){var a=e.options.categories[o];i.push('<li><a href="#octofilter-'+o+'" class="nav-'+o+'" data-toggle="tab">'+a+"</a>"+"</li>")}e.$filtersContainer.find(".nav").html(i).find("li:first").addClass("active")},e.prototype.populateFilterContainer=function(e){var i=this;e=t.extend({},e),t.isEmptyObject(i.options.categories)&&(t.each(e,function(t){i.options.categories[t]=t}),i.makeFilterContainer());var o=[],a=function(t){var e=t.name||t.value||t;return-1!==e.toLowerCase().indexOf(i.$input.val().toLowerCase())};for(var n in i.options.categories){"string"==typeof e[n]&&(e[n]=t.parseJSON(e[n])),i.$input.val().length>=i.options.minChars&&(e[n]=t.grep(e[n],a));var r=[];if(e[n].length)for(var s in e[n]){var l="octofilter-link",c=s.name||s.value||e[n][s];-1!==t.inArray(c,i.selectedFilters[n])&&(l+=" octofiltered"),r.push(t("<a/>",{text:c,"class":l,"data-category":n,"data-value":c}))}else r.push(t("<span/>",{text:i.options.categories[n].toLowerCase()+" not found.","class":"octofilter-not-found"}));o.push(t("<div/>",{id:"octofilter-"+n,"class":"tab-pane"}).html(r))}i.$filtersContainer.find(".tab-content").html(o);var f,p=i.$filtersContainer.find(".octofilter-link:not(.octofiltered):first");f=p.length?p.closest(".tab-pane").addClass("active"):i.$filtersContainer.find(".tab-pane:first").addClass("active"),i.$filtersContainer.find('[href="#'+f.attr("id")+'"]').tab("show"),i.$input.val().length>=i.options.minChars&&p.addClass("octofilter-active")},e.prototype.search=function(e,i){if(this.cacheData[e])this.populateFilterContainer(this.cacheData[e]),"function"==typeof i&&i(),"function"==typeof this.options.onSearch&&this.options.onSearch.apply(this,[this.cacheData[e]]);else if("string"==typeof this.options.source){var o=this,a={};a[this.options.paramName]=e,t.getJSON(this.options.source,a,function(t){o.cacheData[e]=t,o.$filtersContainer||o.makeFilterContainer(),o.populateFilterContainer(t),"function"==typeof i&&i(),"function"==typeof o.options.onSearch&&o.options.onSearch.apply(o,[t])})}else this.$filtersContainer||this.makeFilterContainer(),this.populateFilterContainer(this.options.source),"function"==typeof i&&i(),"function"==typeof this.options.onSearch&&this.options.onSearch.apply(this,[this.source])},e.prototype.select=function(e){var i=this,o=i.$filtersContainer.find('.octofilter-link[data-value="'+e+'"]'),a=o.data("category");if(-1!==t.inArray(e,i.selectedFilters[a]))return i.$input.focus(),void 0;i.selectedFilters[a]||(i.selectedFilters[a]=[]),i.selectedFilters[a].push(e);var n=t("<span/>",{"class":"octofilter-label",text:o.text(),"data-value":e,"data-category":a});t("<a/>",{"class":"octofilter-clear",html:"&times;"}).appendTo(n);var r=i.$container.find(".octofilter-label");r.length?r.last().after(n):i.$container.prepend(n),i.$input.val("").focus(),i.search(""),"function"==typeof i.options.onSelect&&i.options.onSelect.apply(i,[i.selectedFilters])},e.prototype.clear=function(t){var e=this;if(t){var i=e.$container.find('.octofilter-label[data-value="'+t+'"]').remove(),o=i.data("category");e.selectedFilters[o].splice(e.selectedFilters[o].indexOf(t),1)}else e.$container.find(".octofilter-label").remove(),e.selectedFilters={},e.$input.val("");e.$input.focus(),e.search(e.$input.val()),"function"==typeof e.options.onClear&&e.options.onClear.apply(e,[e.selectedFilters])},t.fn.octofilter=function(i){return this.each(function(){var o=t(this),a=o.data("octofilter"),n=t.extend({},e.defaults,o.data(),"object"==typeof i&&i);a||o.data("octofilter",new e(this,n)),"string"==typeof i&&a[i]()})},t.fn.octofilter.Constructor=e})(window.jQuery);